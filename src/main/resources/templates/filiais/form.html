<!-- File: templates/filiais/form.html -->
<!DOCTYPE html>
<html lang="pt-br"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head>
    <!-- head global (j√° inclui mototrack.css) -->
    <th:block th:replace="~{fragments/head :: head(${id != null} ? 'MotoTrack ‚Ä¢ Editar Filial' : 'MotoTrack ‚Ä¢ Nova Filial')}"></th:block>
    <!-- opcional: incluir css expl√≠cito -->
    <th:block th:replace="~{fragments/css :: mototrack}"></th:block>
</head>

<body>
<div class="wrap">
    <!-- Navbar -->
    <div th:replace="~{fragments/navbar :: navbar}"></div>

    <main class="mt-20" aria-label="Formul√°rio de Filial">
        <!-- Sucesso -->
        <div class="flash ok" th:if="${msgSucesso}" th:text="${msgSucesso}"></div>

        <!-- Form principal -->
        <section class="card" aria-labelledby="form-title">
            <h2 id="form-title" th:text="${id != null ? '‚úèÔ∏è Editar Filial' : 'üè¢ Nova Filial'}">üè¢ Nova Filial</h2>
            <p class="muted" th:if="${id == null}">Preencha os dados abaixo para criar uma filial.</p>
            <p class="muted" th:if="${id != null}">Atualize apenas os campos necess√°rios.</p>

            <form th:action="${id != null} ? @{|/filiais/ui/${id}|} : @{/filiais/ui}"
                  method="post" th:object="${filial}">
                <!-- Erros globais -->
                <div class="flash err" th:if="${#fields.hasErrors('*')}">
                    <strong>Erros de valida√ß√£o:</strong>
                    <ul style="margin:8px 0 0 18px">
                        <li th:each="e : ${#fields.errors('*')}" th:text="${e}"></li>
                    </ul>
                </div>

                <!-- Grid dos campos (mesmo layout do .filter) -->
                <div class="filter">
                    <!-- Nome -->
                    <div class="grid-span-2-md">
                        <label for="nome">Nome</label>
                        <input id="nome" type="text" th:field="*{nome}" placeholder="P√°tio Lapa" required/>
                        <div class="err" th:errors="*{nome}" aria-live="polite"></div>
                    </div>

                    <!-- Endere√ßo -->
                    <div class="grid-span-all">
                        <label for="endereco">Endere√ßo</label>
                        <input id="endereco" type="text" th:field="*{endereco}" placeholder="Rua, n√∫mero, complemento"/>
                        <div class="err" th:errors="*{endereco}" aria-live="polite"></div>
                    </div>

                    <!-- Bairro -->
                    <div>
                        <label for="bairro">Bairro</label>
                        <input id="bairro" type="text" th:field="*{bairro}" placeholder="Bairro"/>
                        <div class="err" th:errors="*{bairro}" aria-live="polite"></div>
                    </div>

                    <!-- Cidade -->
                    <div>
                        <label for="cidade">Cidade</label>
                        <input id="cidade" type="text" th:field="*{cidade}" placeholder="S√£o Paulo"/>
                        <div class="err" th:errors="*{cidade}" aria-live="polite"></div>
                    </div>

                    <!-- Estado -->
                    <div>
                        <label for="estado">Estado</label>
                        <input id="estado" type="text" th:field="*{estado}" placeholder="SP" maxlength="2"/>
                        <div class="err" th:errors="*{estado}" aria-live="polite"></div>
                    </div>

                    <!-- CEP -->
                    <div>
                        <label for="cep">CEP</label>
                        <input id="cep" type="text" th:field="*{cep}" placeholder="00000-000"
                               inputmode="numeric" pattern="\d{5}-?\d{3}" maxlength="9"
                               oninput="this.value=this.value.replace(/\D/g,'').slice(0,8).replace(/(\d{5})(\d)/,'$1-$2');"/>
                        <div class="err" th:errors="*{cep}" aria-live="polite"></div>
                    </div>

                    <!-- Latitude -->
                    <div>
                        <label for="latitude">Latitude</label>
                        <input id="latitude" type="number" step="0.000001" th:field="*{latitude}" placeholder="-23.564312"/>
                        <div class="err" th:errors="*{latitude}" aria-live="polite"></div>
                    </div>

                    <!-- Longitude -->
                    <div>
                        <label for="longitude">Longitude</label>
                        <input id="longitude" type="number" step="0.000001" th:field="*{longitude}" placeholder="-46.654212"/>
                        <div class="err" th:errors="*{longitude}" aria-live="polite"></div>
                    </div>

                    <!-- Raio de Geofence -->
                    <div>
                        <label for="raioGeofenceMetros">Raio de Geofence (m)</label>
                        <input id="raioGeofenceMetros" type="number" step="1" th:field="*{raioGeofenceMetros}" placeholder="100"/>
                        <small class="muted">Dist√¢ncia em metros para cercamento geogr√°fico da filial.</small>
                        <div class="err" th:errors="*{raioGeofenceMetros}" aria-live="polite"></div>
                    </div>
                </div>

                <!-- CSRF -->
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

                <!-- A√ß√µes -->
                <div class="actions">
                    <button type="submit" class="btn primary"
                            th:text="${id != null ? 'Atualizar Filial' : 'Salvar Filial'}">Salvar</button>
                    <a class="btn ghost" th:href="@{/filiais/ui}">Voltar</a>
                </div>
            </form>
        </section>

        <!-- Excluir (somente ADMIN e quando h√° id) -->
        <section class="card mt-14" th:if="${id != null}" sec:authorize="hasRole('ADMIN')" aria-label="A√ß√µes avan√ßadas">
            <h2>A√ß√µes</h2>
            <form th:action="@{|/filiais/ui/${id}/excluir|}" method="post" style="display:inline">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                <button class="btn danger" type="submit" onclick="return confirm('Confirmar exclus√£o?')">Excluir</button>
            </form>
        </section>
    </main>

    <!-- Footer -->
    <div th:replace="~{fragments/footer :: footer}"></div>
</div>
</body>
</html>
