<!-- File: templates/filiais/lista.html -->
<!DOCTYPE html>
<html lang="pt-br"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head>
    <th:block th:replace="~{fragments/head :: head('MotoTrack ‚Ä¢ Filiais')}"></th:block>
    <th:block th:replace="~{fragments/css :: mototrack}"></th:block>
    <title>MotoTrack</title>
</head>

<body>
<div class="wrap">
    <div th:replace="~{fragments/navbar :: navbar}"></div>

    <main class="mt-20" aria-label="Lista de Filiais">
        <div class="page-wrap">
            <div th:replace="~{fragments/flash :: banners}"></div>

            <section class="card">
                <h2>üè¢ Filiais</h2>

                <!-- Filtro -->
                <form class="filter" th:action="@{/filiais/ui}" method="get" aria-label="Filtro de filiais">
                    <div>
                        <label for="f-nome">Nome</label>
                        <input id="f-nome" type="text" name="nome"
                               th:value="${filtro != null ? filtro.nome : ''}"
                               placeholder="Nome da filial"/>
                    </div>

                    <div>
                        <label for="f-cidade">Cidade</label>
                        <input id="f-cidade" type="text" name="cidade"
                               th:value="${filtro != null ? filtro.cidade : ''}"
                               placeholder="Cidade"/>
                    </div>

                    <div>
                        <label for="f-estado">Estado</label>
                        <input id="f-estado" type="text" name="estado"
                               th:value="${filtro != null ? filtro.estado : ''}"
                               placeholder="UF"/>
                    </div>

                    <div>
                        <label for="f-cep">CEP</label>
                        <input id="f-cep" type="text" name="cep"
                               th:value="${filtro != null ? filtro.cep : ''}"
                               placeholder="00000-000"
                               inputmode="numeric" pattern="\d{5}-?\d{3}" maxlength="9"
                               oninput="this.value=this.value.replace(/\D/g,'').slice(0,8).replace(/(\d{5})(\d)/,'$1-$2');"/>
                    </div>

                    <div class="row">
                        <button class="btn ghost" type="submit">Filtrar</button>
                        <a class="btn ghost" th:href="@{/filiais/ui}">Limpar</a>
                    </div>
                </form>

                <!-- A√ß√µes ADMIN -->
                <div class="row my-12" sec:authorize="hasRole('ADMIN')">
                    <a class="btn primary" th:href="@{/filiais/ui/novo}">‚ûï Nova filial</a>
                </div>

                <!-- Tabela -->
                <div class="table-wrap" role="region" aria-label="Tabela de filiais">
                    <table>
                        <thead>
                        <tr>
                            <th class="col-id">ID</th>
                            <th>Nome</th>
                            <th>Cidade</th>
                            <th>Estado</th>
                            <th>CEP</th>
                            <th>Latitude</th>
                            <th>Longitude</th>
                            <th>Raio (m)</th>
                            <th class="col-actions">A√ß√µes</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:each="row : ${page.content}">
                            <td th:text="${row.id}"></td>
                            <td th:text="${row.nome}"></td>
                            <td th:text="${row.cidade}"></td>
                            <td th:text="${row.estado}"></td>
                            <td th:text="${row.cep}"></td>
                            <td th:text="${row.latitude}"></td>
                            <td th:text="${row.longitude}"></td>
                            <td th:text="${row.raioGeofenceMetros}"></td>
                            <td class="actions-cell">
                                <a class="btn warn"
                                   th:href="@{|/filiais/ui/${row.id}/editar|}"
                                   sec:authorize="hasRole('ADMIN')">Editar</a>

                                <form class="inline"
                                      th:action="@{|/filiais/ui/${row.id}/excluir|}"
                                      method="post" sec:authorize="hasRole('ADMIN')">
                                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                                    <button class="btn danger" type="submit"
                                            onclick="return confirm('Confirmar exclus√£o?')">Excluir
                                    </button>
                                </form>
                            </td>
                        </tr>

                        <tr th:if="${page.content.size() == 0}">
                            <td colspan="9" class="text-center">
                                <span class="text-muted">Nenhum registro encontrado.</span>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Pagina√ß√£o (preservando filtros) -->
                <div class="pager" aria-label="Pagina√ß√£o">
                    <span>
                        P√°gina <strong th:text="${page.number + 1}"></strong>
                        de <strong th:text="${page.totalPages}"></strong>
                    </span>

                    <span th:if="${page.hasPrevious()}">
                        <a th:href="@{|/filiais/ui?page=${page.number - 1}&size=${page.size}
                                      &nome=${filtro != null ? filtro.nome : '' }
                                      &cidade=${filtro != null ? filtro.cidade : '' }
                                      &estado=${filtro != null ? filtro.estado : '' }
                                      &cep=${filtro != null ? filtro.cep : '' }|}">
                            Anterior
                        </a>
                    </span>

                    <span th:if="${page.hasNext()}">
                        <a th:href="@{|/filiais/ui?page=${page.number + 1}&size=${page.size}
                                      &nome=${filtro != null ? filtro.nome : '' }
                                      &cidade=${filtro != null ? filtro.cidade : '' }
                                      &estado=${filtro != null ? filtro.estado : '' }
                                      &cep=${filtro != null ? filtro.cep : '' }|}">
                            Pr√≥xima
                        </a>
                    </span>
                </div>
            </section>
        </div>
    </main>

    <div th:replace="~{fragments/footer :: footer}"></div>
</div>
</body>
</html>
