<!-- File: templates/usuarios/form.html -->
<!DOCTYPE html>
<html lang="pt-br"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head>
    <!-- head global (j√° inclui mototrack.css) -->
    <th:block th:replace="~{fragments/head :: head(${id != null} ? 'MotoTrack ‚Ä¢ Editar Usu√°rio' : 'MotoTrack ‚Ä¢ Novo Usu√°rio')}"></th:block>
    <!-- opcional: incluir css expl√≠cito -->
    <th:block th:replace="~{fragments/css :: mototrack}"></th:block>
</head>

<body>
<div class="wrap">
    <!-- Navbar -->
    <div th:replace="~{fragments/navbar :: navbar}"></div>

    <main class="mt-20" aria-label="Formul√°rio de Usu√°rio">
        <!-- Sucesso -->
        <div class="flash ok" th:if="${msgSucesso}" th:text="${msgSucesso}"></div>

        <!-- Form principal -->
        <section class="card" aria-labelledby="form-title">
            <h2 id="form-title" th:text="${id != null ? '‚úèÔ∏è Editar Usu√°rio' : 'üë§ Novo Usu√°rio'}">üë§ Novo Usu√°rio</h2>
            <p class="muted" th:if="${id == null}">Preencha os dados abaixo para criar um novo usu√°rio.</p>
            <p class="muted" th:if="${id != null}">Atualize apenas os campos necess√°rios. A senha s√≥ √© pedida na cria√ß√£o.</p>

            <form th:action="${id != null} ? @{|/usuarios/ui/${id}|} : @{/usuarios/ui}"
                  method="post" th:object="${usuario}">
                <!-- Erros globais -->
                <div class="flash err" th:if="${#fields.hasErrors('*')}">
                    <strong>Erros de valida√ß√£o:</strong>
                    <ul style="margin:8px 0 0 18px">
                        <li th:each="e : ${#fields.errors('*')}" th:text="${e}"></li>
                    </ul>
                </div>

                <!-- Grid dos campos (mesmo layout do .filter) -->
                <div class="filter">
                    <!-- Nome -->
                    <div>
                        <label for="nome">Nome</label>
                        <input id="nome" type="text" th:field="*{nome}" placeholder="Nome completo" autocomplete="name" required/>
                        <div class="err" th:errors="*{nome}" aria-live="polite"></div>
                    </div>

                    <!-- Email -->
                    <div>
                        <label for="email">Email (login)</label>
                        <input id="email" type="email" th:field="*{email}" placeholder="email@dominio.com" autocomplete="username" required/>
                        <div class="err" th:errors="*{email}" aria-live="polite"></div>
                    </div>

                    <!-- Perfil -->
                    <div>
                        <label for="perfil">Perfil</label>
                        <select id="perfil" th:field="*{perfil}" required>
                            <option value="" disabled th:selected="${usuario == null or usuario.perfil == null}">Selecione‚Ä¶</option>
                            <option value="USER">USER</option>
                            <option value="ADMIN">ADMIN</option>
                        </select>
                        <div class="err" th:errors="*{perfil}" aria-live="polite"></div>
                    </div>

                    <!-- Senha ‚Äî somente cria√ß√£o -->
                    <div th:if="${id == null}">
                        <label for="senha">Senha</label>
                        <input id="senha" type="password" th:field="*{senha}" minlength="6" placeholder="m√≠n. 6 caracteres" autocomplete="new-password" required/>
                        <div class="err" th:errors="*{senha}" aria-live="polite"></div>
                    </div>

                    <!-- Filial (opcional; aparece se lista foi enviada pelo controller) -->
                    <div th:if="${filiais != null}" class="grid-span-all">
                        <label for="filial">Filial</label>
                        <select id="filial" th:field="*{filial.id}">
                            <option th:value="" th:selected="${usuario == null or usuario.filial == null}">Sem filial</option>
                            <option th:each="f : ${filiais}" th:value="${f.id}" th:text="${f.nome}"></option>
                        </select>
                        <small class="muted">Opcional. Selecione uma filial para vincular o usu√°rio.</small>
                        <div class="err" th:errors="*{filial}" aria-live="polite"></div>
                    </div>
                </div>

                <!-- CSRF -->
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

                <!-- A√ß√µes -->
                <div class="actions">
                    <button type="submit" class="btn primary"
                            th:text="${id != null ? 'Atualizar usu√°rio' : 'Salvar usu√°rio'}">Salvar</button>
                    <a class="btn ghost" th:href="@{/usuarios/ui}">Voltar</a>
                </div>
            </form>
        </section>

        <!-- Excluir (somente ADMIN e quando h√° id) -->
        <section class="card mt-14" th:if="${id != null}" sec:authorize="hasRole('ADMIN')" aria-label="A√ß√µes avan√ßadas">
            <h2>A√ß√µes</h2>
            <form th:action="@{'/usuarios/ui/' + ${id}}" method="post" style="display:inline">
                <input type="hidden" name="_method" value="delete"/>
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                <button class="btn danger" type="submit" onclick="return confirm('Confirmar exclus√£o?')">Excluir</button>
            </form>
        </section>
    </main>

    <!-- Footer -->
    <div th:replace="~{fragments/footer :: footer}"></div>
</div>
</body>
</html>
