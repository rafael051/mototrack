<!-- File: templates/motos/form.html -->
<!DOCTYPE html>
<html lang="pt-br"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head>
    <!-- head global (já inclui mototrack.css) -->
    <th:block th:replace="~{fragments/head :: head(${id != null} ? 'MotoTrack • Editar Moto' : 'MotoTrack • Nova Moto')}"></th:block>
    <!-- opcional: incluir css explícito -->
    <th:block th:replace="~{fragments/css :: mototrack}"></th:block>
</head>

<body>
<div class="wrap">
    <!-- Navbar -->
    <div th:replace="~{fragments/navbar :: navbar}"></div>

    <main class="mt-20" aria-label="Formulário de Moto">
        <!-- Sucesso -->
        <div class="flash ok" th:if="${msgSucesso}" th:text="${msgSucesso}"></div>

        <!-- Form principal -->
        <section class="card" aria-labelledby="form-title">
            <h2 id="form-title" th:text="${id != null ? '✏️ Editar Moto' : '🛵 Nova Moto'}">🛵 Nova Moto</h2>
            <p class="muted" th:if="${id == null}">Preencha os dados abaixo para cadastrar uma nova moto.</p>
            <p class="muted" th:if="${id != null}">Atualize apenas os campos necessários.</p>

            <form th:action="${id != null} ? @{|/motos/ui/${id}|} : @{/motos/ui}"
                  method="post" th:object="${moto}">
                <!-- Erros globais -->
                <div class="flash err" th:if="${#fields.hasErrors('*')}">
                    <strong>Erros de validação:</strong>
                    <ul class="list-errors">
                        <li th:each="e : ${#fields.errors('*')}" th:text="${e}"></li>
                    </ul>
                </div>

                <!-- Grid dos campos (mesmo layout do .filter) -->
                <div class="filter">
                    <div>
                        <label for="placa">Placa</label>
                        <input id="placa" type="text" th:field="*{placa}" placeholder="AAA0A00" required/>
                        <div class="err" th:errors="*{placa}" aria-live="polite"></div>
                    </div>

                    <div>
                        <label for="modelo">Modelo</label>
                        <input id="modelo" type="text" th:field="*{modelo}" placeholder="Modelo" required/>
                        <div class="err" th:errors="*{modelo}" aria-live="polite"></div>
                    </div>

                    <div>
                        <label for="marca">Marca</label>
                        <input id="marca" type="text" th:field="*{marca}" placeholder="Marca" required/>
                        <div class="err" th:errors="*{marca}" aria-live="polite"></div>
                    </div>

                    <div>
                        <label for="ano">Ano</label>
                        <input id="ano" type="number" th:field="*{ano}" min="2000" placeholder="2022" required/>
                        <div class="err" th:errors="*{ano}" aria-live="polite"></div>
                    </div>

                    <div>
                        <label for="status">Status</label>
                        <input id="status" type="text" th:field="*{status}" placeholder="Disponível, Locada..." required/>
                        <div class="err" th:errors="*{status}" aria-live="polite"></div>
                    </div>

                    <!-- Filial (ID numérico por padrão). Se quiser, envie 'filiais' no model e manteremos o mesmo binding (*{filialId}) -->
                    <div th:if="${filiais == null}">
                        <label for="filialId">Filial (ID)</label>
                        <input id="filialId" type="number" th:field="*{filialId}" placeholder="ID da filial"/>
                        <div class="err" th:errors="*{filialId}" aria-live="polite"></div>
                    </div>

                    <div th:if="${filiais != null}">
                        <label for="filialIdSel">Filial</label>
                        <select id="filialIdSel" th:field="*{filialId}">
                            <option th:value="">Sem filial</option>
                            <option th:each="f : ${filiais}" th:value="${f.id}" th:text="${f.nome}"></option>
                        </select>
                        <small class="muted">Opcional. Selecione uma filial para vincular a moto.</small>
                        <div class="err" th:errors="*{filialId}" aria-live="polite"></div>
                    </div>

                    <div>
                        <label for="latitude">Latitude</label>
                        <input id="latitude" type="number" step="0.000001" th:field="*{latitude}" placeholder="-23.564312"/>
                        <div class="err" th:errors="*{latitude}" aria-live="polite"></div>
                    </div>

                    <div>
                        <label for="longitude">Longitude</label>
                        <input id="longitude" type="number" step="0.000001" th:field="*{longitude}" placeholder="-46.654212"/>
                        <div class="err" th:errors="*{longitude}" aria-live="polite"></div>
                    </div>
                </div>

                <!-- CSRF -->
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

                <!-- Ações -->
                <div class="actions">
                    <button type="submit" class="btn primary"
                            th:text="${id != null ? 'Atualizar moto' : 'Salvar moto'}">Salvar</button>
                    <a class="btn ghost" th:href="@{/motos/ui}">Voltar</a>
                </div>
            </form>
        </section>

        <!-- Excluir (somente ADMIN e quando há id) -->
        <section class="card mt-14" th:if="${id != null}" sec:authorize="hasRole('ADMIN')" aria-label="Ações avançadas">
            <h2>Ações</h2>
            <form th:action="@{'/motos/ui/' + ${id} + '/excluir'}" method="post" class="inline">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                <button class="btn danger" type="submit" onclick="return confirm('Confirmar exclusão?')">Excluir</button>
            </form>
        </section>
    </main>

    <!-- Footer -->
    <div th:replace="~{fragments/footer :: footer}"></div>
</div>
</body>
</html>
